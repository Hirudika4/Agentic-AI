name: Deploy JAC-GPT Fullstack with jac-scale

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-jac-gpt-fullstack:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/jac-gpt-') || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Configure AWS credentials using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.2.0
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::776241927220:role/GitHubActionsJaseciDeployRole
          role-session-name: GitHubActions-JacGPT
          audience: sts.amazonaws.com

      # Update kubeconfig to connect to EKS cluster
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region us-east-2 --name jaseci-cluster
          kubectl config current-context

      # Set up Python
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Install required packages (including app dependencies for local validation)
      - name: Install Jaseci packages
        run: |
          pip install --upgrade pip
          pip install jaclang jac-client jac-scale byllm

      # Install app dependencies (required for jac start to validate main.jac locally)
      - name: Install app dependencies
        run: |
          pip install python-dotenv requests pymongo langchain-openai langchain-community langchain-chroma pypdf sentence-transformers faiss-cpu
        working-directory: jac-gpt-fullstack

      # Destroy existing deployment
      - name: Destroy existing deployment
        run: |
          jac destroy main.jac || echo "No existing deployment to destroy"
          sleep 15
        continue-on-error: true
        working-directory: jac-gpt-fullstack

      # Deploy using jac-scale (OPENAI_API_KEY passed so jac-scale includes it in deployment)
      - name: Deploy JAC-GPT Fullstack with jac-scale
        run: |
          jac start main.jac --scale
        working-directory: jac-gpt-fullstack
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # Get deployment status
      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl get deployments -n jac-gpt-test
          kubectl get services -n jac-gpt-test
          kubectl get pods -n jac-gpt-test

      # Output deployment summary
      - name: Deployment Summary
        if: always()
        run: |
          echo "## JAC-GPT Fullstack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: jac-gpt-test" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: jac-gpt-test" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: jaseci-cluster" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: us-east-2" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "- **Release Tag**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n jac-gpt-test 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Unable to fetch deployment status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
